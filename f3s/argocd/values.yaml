# ArgoCD Helm Chart Values Override
# Following f3s cluster patterns: non-HA, single instance deployment

global:
  domain: argocd.f3s.buetow.org

# Disable HA mode - following cluster pattern
redis-ha:
  enabled: false

# Use standard Redis with authentication
redis:
  enabled: true

# Controller configuration (manages k8s resources)
controller:
  replicas: 1
  # Enable metrics for Prometheus integration
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      namespace: cicd
      additionalLabels:
        release: prometheus

# Server configuration (API/Web UI)
server:
  replicas: 1
  # Run in insecure mode - TLS termination at ingress
  insecure: true
  # Disable built-in ingress - using separate manifest
  ingress:
    enabled: false
  # Resource limits
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi
  # Enable metrics for Prometheus integration
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      namespace: cicd
      additionalLabels:
        release: prometheus

# Repo Server configuration (clones repos, generates manifests)
repoServer:
  replicas: 1
  # Pod security context - fsGroup ensures secret volumes are readable by argocd user (999)
  podSecurityContext:
    fsGroup: 999
  # Enable persistence for repo cache - mount PVC at /home/argocd/repo-cache
  # This avoids conflict with default /tmp mount used by ArgoCD
  volumes:
    - name: repo-server-data
      persistentVolumeClaim:
        claimName: argocd-repo-server-pvc
    - name: ssh-agent-socket
      emptyDir: {}
    - name: git-ssh-key
      secret:
        secretName: argocd-git-ssh-key
        defaultMode: 0400
  volumeMounts:
    - name: repo-server-data
      mountPath: /home/argocd/repo-cache
    - name: ssh-agent-socket
      mountPath: /tmp/ssh-agent
  # SSH agent sidecar to provide SSH_AUTH_SOCK for git operations
  extraContainers:
    - name: ssh-agent
      image: alpine:3.19
      command:
        - sh
        - -c
        - |
          # Install openssh as root
          apk add --no-cache openssh
          # Create argocd user if it doesn't exist
          adduser -D -u 999 argocd 2>/dev/null || true
          # Start ssh-agent as argocd user
          su argocd -s /bin/sh -c '
            eval $(ssh-agent -s -a /tmp/ssh-agent/socket)
            ssh-add /tmp/ssh-key/sshPrivateKey
            # Keep agent running
            while true; do sleep 3600; done
          '
      volumeMounts:
        - name: ssh-agent-socket
          mountPath: /tmp/ssh-agent
        - name: git-ssh-key
          mountPath: /tmp/ssh-key
  # Configure repo-server to use the persistent cache directory and SSH agent
  env:
    - name: XDG_CACHE_HOME
      value: /home/argocd/repo-cache
    - name: SSH_AUTH_SOCK
      value: /tmp/ssh-agent/socket
  # Resource limits
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi
  # Enable metrics for Prometheus integration
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      namespace: cicd
      additionalLabels:
        release: prometheus

# ApplicationSet controller (multi-app management)
applicationSet:
  replicas: 1

# Notifications controller - disabled
notifications:
  enabled: false

# Dex (SSO/OAuth) - disabled for simplicity
dex:
  enabled: false

# CRD installation
crds:
  install: true
  keep: true

# Server configuration parameters - run in insecure mode
configs:
  params:
    server.insecure: true
  # Note: argocdServerAdminPassword is NOT set (left empty)
  # This means:
  # - helm install: Generates random password in argocd-initial-admin-secret
  # - helm upgrade: Does NOT reset the password (preserves user changes)
  # - helm uninstall: Deletes secret along with all resources
