apiVersion: v1
kind: Secret
metadata:
  name: additional-scrape-configs
  namespace: monitoring
  annotations:
    argocd.argoproj.io/sync-wave: "1"
type: Opaque
stringData:
  additional-scrape-configs.yaml: |
    - job_name: 'node-exporter'
      static_configs:
        - targets:
          - '192.168.2.130:9100'  # f0 via WireGuard
          - '192.168.2.131:9100'  # f1 via WireGuard
          - '192.168.2.132:9100'  # f2 via WireGuard
          labels:
            os: freebsd
        - targets:
          - '192.168.2.110:9100'  # blowfish via WireGuard
          - '192.168.2.111:9100'  # fishfinger via WireGuard
          labels:
            os: openbsd

    - job_name: 'pushgateway'
      honor_labels: true
      static_configs:
        - targets:
          - 'pushgateway.monitoring.svc.cluster.local:9091'

    # Radicale does not expose Prometheus metrics, so we don't scrape it.
    # The radicale-drop job and kubernetes-services-no-radicale job below
    # ensure radicale is excluded from any service discovery.

    # Drop radicale service from being scraped (does not expose Prometheus metrics)
    - job_name: 'radicale-drop'
      static_configs:
        - targets:
          - 'radicale-service.services.svc.cluster.local:80'
      relabel_configs:
        - source_labels: [__address__]
          action: drop

    # Kubernetes service discovery with radicale dropped
    - job_name: 'kubernetes-services-no-radicale'
      kubernetes_sd_configs:
        - role: service
          namespaces:
            names:
              - services
      relabel_configs:
        # Drop radicale service
        - source_labels: [__meta_kubernetes_service_name]
          regex: radicale-service
          action: drop
        # Keep only metrics ports
        - source_labels: [__meta_kubernetes_service_port_name]
          regex: metrics|prometheus
          action: keep
        - source_labels: [__meta_kubernetes_service_name]
          target_label: job
        - source_labels: [__meta_kubernetes_namespace]
          target_label: namespace
