NAMESPACE := "services"
APP_NAME := "immich"

status:
    @echo "=== Pods ==="
    @kubectl get pods -n {{NAMESPACE}} | grep immich
    @echo ""
    @echo "=== Services ==="
    @kubectl get svc -n {{NAMESPACE}} | grep immich
    @echo ""
    @echo "=== Ingress ==="
    @kubectl get ingress -n {{NAMESPACE}} immich-ingress
    @echo ""
    @echo "=== PVCs ==="
    @kubectl get pvc -n {{NAMESPACE}} | grep immich
    @echo ""
    @echo "=== ArgoCD Status ==="
    @kubectl get application {{APP_NAME}} -n cicd -o jsonpath='Sync: {.status.sync.status}, Health: {.status.health.status}' 2>/dev/null && echo ""

logs-server lines="100":
    kubectl logs -n {{NAMESPACE}} -l app=immich-server --tail={{lines}} -f

logs-ml lines="100":
    kubectl logs -n {{NAMESPACE}} -l app=immich-machine-learning --tail={{lines}} -f

logs-postgres lines="100":
    kubectl logs -n {{NAMESPACE}} -l app=immich-postgres --tail={{lines}} -f

logs-valkey lines="100":
    kubectl logs -n {{NAMESPACE}} -l app=immich-valkey --tail={{lines}} -f

port-forward port="2283":
    @echo "Forwarding immich server to localhost:{{port}}"
    kubectl port-forward -n {{NAMESPACE}} svc/immich-server {{port}}:2283

sync:
    @echo "Triggering ArgoCD sync..."
    @kubectl annotate application {{APP_NAME}} -n cicd argocd.argoproj.io/refresh=normal --overwrite
    @sleep 2
    @kubectl get application {{APP_NAME}} -n cicd -o jsonpath='Sync: {.status.sync.status}, Health: {.status.health.status}' && echo ""

argocd-status:
    argocd app get {{APP_NAME}} --core

restart-server:
    @echo "Restarting immich server..."
    kubectl rollout restart -n {{NAMESPACE}} deployment/immich-server

restart-ml:
    @echo "Restarting immich machine learning..."
    kubectl rollout restart -n {{NAMESPACE}} deployment/immich-machine-learning

restart-postgres:
    @echo "Restarting immich postgres..."
    kubectl rollout restart -n {{NAMESPACE}} deployment/immich-postgres

restart-valkey:
    @echo "Restarting immich valkey..."
    kubectl rollout restart -n {{NAMESPACE}} deployment/immich-valkey

restart: restart-server restart-ml
