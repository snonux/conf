apiVersion: apps/v1
kind: Deployment
metadata:
  name: filerise
  namespace: services
spec:
  replicas: 1
  selector:
    matchLabels:
      app: filerise
  template:
    metadata:
      labels:
        app: filerise
    spec:
      securityContext:
        fsGroup: 1000
      initContainers:
      - name: setup-directories
        image: busybox:latest
        command:
        - sh
        - -c
        - |
          mkdir -p /var/www/metadata/log
          mkdir -p /var/www/uploads
          mkdir -p /var/www/users
          mkdir -p /var/www/config
          mkdir -p /var/www/sessions
          touch /var/www/metadata/log/error.log
          touch /var/www/metadata/log/access.log
          touch /var/www/users/users.txt
          echo "[]" > /var/www/metadata/createdTags.json
          chown -R 1000:1000 /var/www/metadata /var/www/uploads /var/www/users /var/www/config /var/www/sessions
          chmod -R 775 /var/www/metadata /var/www/uploads /var/www/users /var/www/config
          chmod 700 /var/www/sessions
          chmod 664 /var/www/users/users.txt
          chmod 664 /var/www/metadata/createdTags.json
        volumeMounts:
        - name: filerise-uploads
          mountPath: /var/www/uploads
        - name: filerise-users
          mountPath: /var/www/users
        - name: filerise-metadata
          mountPath: /var/www/metadata
        - name: filerise-config
          mountPath: /var/www/config
        - name: filerise-sessions
          mountPath: /var/www/sessions
      containers:
      - name: filerise
        image: error311/filerise-docker:latest
        command: ["/bin/bash", "/usr/local/bin/start-override.sh"]
        ports:
        - containerPort: 80
        env:
        - name: TIMEZONE
          value: "UTC"
        - name: DATE_TIME_FORMAT
          value: "m/d/y  h:iA"
        - name: TOTAL_UPLOAD_SIZE
          value: "5G"
        - name: SECURE
          value: "false"
        - name: PERSISTENT_TOKENS_KEY
          valueFrom:
            secretKeyRef:
              name: filerise-secret
              key: PERSISTENT_TOKENS_KEY
        - name: PUID
          value: "1000"
        - name: PGID
          value: "1000"
        - name: CHOWN_ON_START
          value: "false"
        - name: SCAN_ON_START
          value: "true"
        volumeMounts:
        - name: filerise-uploads
          mountPath: /var/www/uploads
        - name: filerise-users
          mountPath: /var/www/users
        - name: filerise-metadata
          mountPath: /var/www/metadata
        - name: filerise-config
          mountPath: /var/www/config
        - name: filerise-sessions
          mountPath: /var/www/sessions
        - name: start-script
          mountPath: /usr/local/bin/start-override.sh
          subPath: start.sh
      volumes:
      - name: filerise-uploads
        persistentVolumeClaim:
          claimName: filerise-uploads-pvc
      - name: filerise-users
        persistentVolumeClaim:
          claimName: filerise-users-pvc
      - name: filerise-metadata
        persistentVolumeClaim:
          claimName: filerise-metadata-pvc
      - name: filerise-config
        persistentVolumeClaim:
          claimName: filerise-config-pvc
      - name: start-script
        configMap:
          name: filerise-start-script
          defaultMode: 0755
      - name: filerise-sessions
        emptyDir: {}
